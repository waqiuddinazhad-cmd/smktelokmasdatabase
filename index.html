<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Exam Super Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f8fafc; } /* Off-white background */
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .sidebar { background: #ffffff; border-right: 1px solid #e2e8f0; }
        .active-nav { background-color: #e0e7ff; color: #4338ca; border-right: 4px solid #4338ca; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden">

    <aside class="sidebar w-64 flex-shrink-0 flex flex-col justify-between transition-all duration-300">
        <div>
            <div class="p-6 flex items-center gap-3">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">S</div>
                <h1 class="text-xl font-bold tracking-tight text-slate-800">SMK Telok Mas</h1>
            </div>
            
            <nav class="mt-6">
                <a href="#" class="flex items-center gap-3 px-6 py-3 active-nav">
                    <i class="fas fa-chart-line w-5"></i> Dashboard


                </a>
                <a href="#" class="flex items-center gap-3 px-6 py-3 text-slate-500 hover:bg-slate-50">
                    <i class="fas fa-users w-5"></i> Students
                </a>
                <a href="#" class="flex items-center gap-3 px-6 py-3 text-slate-500 hover:bg-slate-50">
                    <i class="fas fa-cog w-5"></i> Settings
                </a>
            </nav>
        </div>

        <div class="p-6 border-t border-slate-100 bg-slate-50">
            <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-4">Filters</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-medium text-slate-500">Exam Type</label>
                    <select id="selExam" class="w-full mt-1 p-2 bg-white border rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="PAT">PAT (Year End)</option>
                        <option value="PPT">PPT (Mid Year)</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-medium text-slate-500">Form</label>
                    <select id="selForm" class="w-full mt-1 p-2 bg-white border rounded text-sm">
                        <option value="ALL">All Forms</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-medium text-slate-500">Class</label>
                    <select id="selClass" class="w-full mt-1 p-2 bg-white border rounded text-sm">
                        <option value="ALL">All Classes</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-medium text-slate-500">Subject Focus</label>
                    <select id="selSubject" class="w-full mt-1 p-2 bg-white border rounded text-sm">
                        </select>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-8">
        <div class="flex justify-between items-end mb-8">
            <div>
                <h2 class="text-2xl font-bold text-slate-800">Examination Overview</h2>
                <p class="text-slate-500 text-sm mt-1">Analyzing performance trends for <span id="lblYear">2023-2025</span></p>
            </div>
            <div class="flex gap-2">
                <button class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 shadow-sm">
                    <i class="fas fa-download mr-2"></i> Export Report
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card p-5 border-l-4 border-indigo-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs text-slate-400 font-semibold uppercase">Total Students</p>
                        <h3 id="kpiStudents" class="text-3xl font-bold text-slate-700 mt-1">0</h3>
                    </div>
                    <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600"><i class="fas fa-user-graduate"></i></div>
                </div>
            </div>
            <div class="card p-5 border-l-4 border-emerald-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs text-slate-400 font-semibold uppercase">Passing Rate</p>
                        <h3 id="kpiPass" class="text-3xl font-bold text-slate-700 mt-1">0%</h3>
                        <p class="text-xs text-emerald-600 mt-1"><i class="fas fa-arrow-up"></i> vs last year</p>
                    </div>
                    <div class="p-2 bg-emerald-50 rounded-lg text-emerald-600"><i class="fas fa-check-circle"></i></div>
                </div>
            </div>
            <div class="card p-5 border-l-4 border-amber-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs text-slate-400 font-semibold uppercase">Average GPMP</p>
                        <h3 id="kpiGPMP" class="text-3xl font-bold text-slate-700 mt-1">0.00</h3>
                        <p class="text-xs text-slate-400 mt-1">Lower is better</p>
                    </div>
                    <div class="p-2 bg-amber-50 rounded-lg text-amber-600"><i class="fas fa-chart-area"></i></div>
                </div>
            </div>
             <div class="card p-5 border-l-4 border-pink-500">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs text-slate-400 font-semibold uppercase">Active Classes</p>
                        <h3 id="kpiClasses" class="text-3xl font-bold text-slate-700 mt-1">0</h3>
                    </div>
                    <div class="p-2 bg-pink-50 rounded-lg text-pink-600"><i class="fas fa-school"></i></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="card p-6 lg:col-span-2">
                <h3 class="font-bold text-lg mb-4 text-slate-700">GPMP Trend Analysis (3 Years)</h3>
                <div class="h-64">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            
            <div class="card p-6">
                <h3 class="font-bold text-lg mb-4 text-slate-700">Demographics</h3>
                <div class="h-64 flex justify-center">
                    <canvas id="demoChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card p-6 lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-slate-700">Grade Distribution Comparison</h3>
                    <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">Click bar to view students</span>
                </div>
                <div class="h-80">
                    <canvas id="gradeChart"></canvas>
                </div>
            </div>

            <div class="card p-0 overflow-hidden flex flex-col">
                <div class="p-4 border-b bg-slate-50">
                    <h3 class="font-bold text-slate-700">Student Drill-down</h3>
                    <p id="drillDownTitle" class="text-xs text-slate-500">Click a grade bar to see details</p>
                </div>
                <div class="overflow-y-auto h-80 p-2" id="studentListContainer">
                    <p class="text-center text-slate-400 mt-10 text-sm">No selection made.</p>
                </div>
            </div>
        </div>

    </main>

    <script>
        let rawData = [];
        let trendChartInstance = null;
        let gradeChartInstance = null;
        let demoChartInstance = null;

        // Configuration: Lower Sec (1-6) vs Upper Sec (0-9)
        const gradePointsLower = {'A':1, 'B':2, 'C':3, 'D':4, 'E':5, 'F':6};
        const gradePointsUpper = {'A+':0, 'A':1, 'A-':2, 'B+':3, 'B':4, 'C+':5, 'C':6, 'D':7, 'E':8, 'G':9};
        
        // 1. Load Data
        Papa.parse('school_exam_data_2023_2025.csv', {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                rawData = results.data;
                initDashboard();
            }
        });

        function initDashboard() {
            populateDropdowns();
            updateDashboard();

            // Event Listeners
            ['selExam', 'selForm', 'selClass', 'selSubject'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    if(id === 'selForm') populateClasses(); 
                    updateDashboard();
                });
            });
        }

        function populateDropdowns() {
            // Unique Forms
            const forms = [...new Set(rawData.map(d => d.TINGKATAN))].sort();
            const selForm = document.getElementById('selForm');
            forms.forEach(f => selForm.innerHTML += `<option value="${f}">${f}</option>`);

            // Initial Subjects (All)
            populateSubjects();
            populateClasses();
        }

        function populateClasses() {
            const form = document.getElementById('selForm').value;
            const selClass = document.getElementById('selClass');
            selClass.innerHTML = '<option value="ALL">All Classes</option>';
            
            const filtered = rawData.filter(d => form === 'ALL' || d.TINGKATAN === form);
            const classes = [...new Set(filtered.map(d => d.KELAS))].sort();
            
            classes.forEach(c => selClass.innerHTML += `<option value="${c}">${c.replace(form, '').trim()}</option>`);
        }

        function populateSubjects() {
            // Scan data keys for subject columns (ignoring Metadata)
            const ignore = ['YEAR','EXAM','BIL','NAMA','NOKP','KELAS','TINGKATAN','JANTINA','JUMLAH_MARKAH','JUMLAH_GRED'];
            const keys = Object.keys(rawData[0]);
            const subjects = keys.filter(k => !ignore.includes(k) && !k.endsWith('G')); // Get subject names, not grades
            
            const selSub = document.getElementById('selSubject');
            selSub.innerHTML = '';
            subjects.forEach(s => {
                // Default to Matematik if available, else first one
                const isSelected = s === 'MM' ? 'selected' : '';
                selSub.innerHTML += `<option value="${s}" ${isSelected}>${s}</option>`;
            });
        }

        function updateDashboard() {
            const exam = document.getElementById('selExam').value;
            const form = document.getElementById('selForm').value;
            const cls = document.getElementById('selClass').value;
            const subject = document.getElementById('selSubject').value;

            // 1. Filter Data for "Current View" (Let's assume 2025 is current, but we load all years for trend)
            // KPI is based on 2025 data (Latest)
            const data2025 = rawData.filter(d => 
                d.YEAR === '2025' && 
                d.EXAM === exam &&
                (form === 'ALL' || d.TINGKATAN === form) &&
                (cls === 'ALL' || d.KELAS === cls)
            );

            // Calculate KPIs
            const totalStudents = data2025.length;
            const passed = data2025.filter(d => {
                const g = d[subject + 'G'];
                return g && g !== 'F' && g !== 'G';
            }).length;
            
            // GPMP Calc
            let totalPoints = 0;
            let count = 0;
            data2025.forEach(d => {
                const g = d[subject + 'G'];
                const pts = d.TINGKATAN.startsWith('T1') || d.TINGKATAN.startsWith('T2') || d.TINGKATAN.startsWith('T3') 
                            ? gradePointsLower[g] : gradePointsUpper[g];
                if(pts !== undefined) { totalPoints += pts; count++; }
            });
            const gpmp = count > 0 ? (totalPoints / count).toFixed(2) : "0.00";

            // Update DOM
            document.getElementById('kpiStudents').innerText = totalStudents;
            document.getElementById('kpiPass').innerText = count > 0 ? Math.round((passed/count)*100) + '%' : '0%';
            document.getElementById('kpiGPMP').innerText = gpmp;
            document.getElementById('kpiClasses').innerText = [...new Set(data2025.map(d => d.KELAS))].length;

            // Render Charts
            renderTrendChart(exam, form, cls, subject);
            renderGradeChart(exam, form, cls, subject);
            renderDemoChart(data2025);
        }

        function renderTrendChart(exam, form, cls, subject) {
            const years = ['2023', '2024', '2025'];
            const trendData = years.map(year => {
                const yearData = rawData.filter(d => 
                    d.YEAR === year && d.EXAM === exam &&
                    (form === 'ALL' || d.TINGKATAN === form) &&
                    (cls === 'ALL' || d.KELAS === cls)
                );
                
                let pts = 0, cnt = 0;
                yearData.forEach(d => {
                    const g = d[subject + 'G'];
                    const val = d.TINGKATAN < 'T4' ? gradePointsLower[g] : gradePointsUpper[g]; // Simplistic form check
                    if(val !== undefined) { pts += val; cnt++; }
                });
                return cnt > 0 ? (pts/cnt).toFixed(2) : null;
            });

            const ctx = document.getElementById('trendChart').getContext('2d');
            if(trendChartInstance) trendChartInstance.destroy();

            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: `GPMP ${subject}`,
                        data: trendData,
                        borderColor: '#4338ca',
                        backgroundColor: 'rgba(67, 56, 202, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderGradeChart(exam, form, cls, subject) {
            // We want a grouped bar chart: For each Grade (A, B, C...), show 3 bars (2023, 2024, 2025)
            const grades = ['A', 'B', 'C', 'D', 'E', 'F', 'G']; // Unified labels for display
            const years = ['2023', '2024', '2025'];
            
            const datasets = years.map((year, i) => {
                const yearData = rawData.filter(d => d.YEAR === year && d.EXAM === exam && (form==='ALL' || d.TINGKATAN===form) && (cls==='ALL' || d.KELAS===cls));
                const counts = grades.map(g => {
                    // Fuzzy match for A+ vs A vs A-
                    return yearData.filter(d => {
                        const grade = d[subject+'G'];
                        if(!grade) return false;
                        return grade.startsWith(g); 
                    }).length;
                });

                return {
                    label: year,
                    data: counts,
                    backgroundColor: i === 2 ? '#4338ca' : (i === 1 ? '#818cf8' : '#e0e7ff')
                };
            });

            const ctx = document.getElementById('gradeChart').getContext('2d');
            if(gradeChartInstance) gradeChartInstance.destroy();

            gradeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: grades, datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (e, activeEls) => {
                        if(activeEls.length > 0) {
                            const gradeIndex = activeEls[0].index;
                            const yearIndex = activeEls[0].datasetIndex;
                            const selectedGrade = grades[gradeIndex];
                            const selectedYear = years[yearIndex];
                            showStudents(selectedYear, selectedGrade, exam, form, cls, subject);
                        }
                    }
                }
            });
        }

        function renderDemoChart(data) {
            const male = data.filter(d => d.JANTINA === 'Lelaki').length;
            const female = data.filter(d => d.JANTINA === 'Perempuan').length;

            const ctx = document.getElementById('demoChart').getContext('2d');
            if(demoChartInstance) demoChartInstance.destroy();

            demoChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Male', 'Female'],
                    datasets: [{
                        data: [male, female],
                        backgroundColor: ['#3b82f6', '#ec4899']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function showStudents(year, gradePrefix, exam, form, cls, subject) {
            const list = document.getElementById('studentListContainer');
            const title = document.getElementById('drillDownTitle');
            
            // Filter
            const students = rawData.filter(d => 
                d.YEAR === year && d.EXAM === exam &&
                (form === 'ALL' || d.TINGKATAN === form) &&
                (cls === 'ALL' || d.KELAS === cls) &&
                d[subject+'G'] && d[subject+'G'].startsWith(gradePrefix)
            );

            title.innerText = `Found ${students.length} students with Grade ${gradePrefix} in ${year}`;
            
            let html = '<div class="space-y-3">';
            students.forEach(s => {
                html += `
                    <div class="flex items-center justify-between p-3 bg-white border rounded shadow-sm hover:shadow-md transition">
                        <div>
                            <p class="font-bold text-sm text-slate-700">${s.NAMA}</p>
                            <p class="text-xs text-slate-400">${s.KELAS}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-lg font-bold ${gradePrefix === 'F' || gradePrefix === 'G' ? 'text-red-500' : 'text-indigo-600'}">${s[subject+'G']}</span>
                            <p class="text-xs text-slate-400">${s[subject]} marks</p>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            list.innerHTML = html;
        }
    </script>
</body>
</html>